/*
Plays the song extracted from:
David_Bowie_-_Space_Oddity.track8.buzzer.json  (selected_track_name: "Choir")
Source data: precomputed event durations in milliseconds + gate times.

Hardware:
- Passive buzzer on D9
  D9 -> 300Î© -> buzzer+ ; buzzer- -> GND

Notes:
- This sketch uses the JSON's per-event duration_ms and gate_ms directly.
- SPEED_PCT scales the whole song timing (100 = original extracted speed).
- TRANSPOSE shifts pitch in semitones (no floating point used).
*/

#include <Arduino.h>
#include <avr/pgmspace.h>

const uint8_t BUZZ_PIN = 9;

// 100 = original timing from JSON. Try 80..130 to taste.
const uint16_t SPEED_PCT = 100;

// Semitone transpose: -12..+12 recommended.
const int8_t TRANSPOSE = 0;

// Optional tiny extra gap after each event (ms)
const uint8_t EXTRA_GAP_MS = 2;

// Semitone multipliers in Q16 fixed-point for -12..+12
// multiplier = 2^(semitone/12) * 65536
const uint32_t SEMI_MUL_Q16[] PROGMEM = {
  32768, 34716, 36781, 38968, 41285, 43740, 46341, 49097, 52016, 55109, 58386, 61858, 65536,
  69433, 73562, 77936, 82570, 87480, 92682, 98193, 104032, 110218, 116772, 123715, 131072
};

const uint16_t N_EVENTS = 328;

// 0 freq means rest. Arrays aligned by event index.
const uint16_t SONG_FREQ_HZ[] PROGMEM = {
  262, 0, 262, 0, 262, 0, 262, 0, 262, 247, 0, 262, 0, 294, 0, 262,
  0, 294, 0, 262, 0, 294, 0, 262, 0, 294, 0, 262, 0, 294, 0, 262,
  0, 330, 0, 330, 0, 330, 0, 349, 0, 392, 0, 392, 0, 392, 0, 349,
  0, 330, 0, 330, 0, 330, 0, 330, 0, 349, 0, 349, 0, 349, 0, 349,
  0, 349, 0, 349, 0, 349, 0, 392, 0, 330, 0, 330, 0, 330, 0, 330,
  0, 349, 0, 349, 0, 349, 0, 349, 0, 349, 0, 392, 0, 330, 0, 349,
  0, 330, 0, 294, 0, 349, 0, 330, 294, 0, 262, 0, 220, 0, 262, 0,
  247, 0, 220, 0, 196, 0, 196, 0, 196, 220, 0, 196, 0, 147, 0, 262,
  0, 262, 0, 247, 220, 0, 196, 0, 233, 0, 233, 0, 233, 0, 262, 0,
  220, 0, 220, 0, 220, 0, 196, 0, 196, 0, 220, 0, 196, 175, 0, 175,
  0, 330, 0, 330, 0, 330, 0, 349, 0, 392, 0, 392, 0, 392, 0, 349,
  0, 330, 0, 330, 0, 330, 0, 330, 0, 349, 0, 349, 0, 349, 0, 349,
  0, 349, 0, 349, 0, 349, 0, 392, 0, 330, 0, 330, 0, 330, 0, 330,
  0, 349, 0, 349, 0, 349, 0, 349, 0, 349, 0, 392, 0, 330, 0, 349,
  0, 330, 0, 294, 0, 349, 0, 330, 294, 0, 262, 0, 220, 0, 262, 0,
  247, 0, 220, 0, 196, 0, 196, 0, 196, 220, 0, 196, 0, 147, 0, 262,
  0, 262, 0, 247, 220, 0, 196, 0, 233, 0, 233, 0, 233, 0, 262, 0,
  220, 0, 220, 0, 220, 0, 196, 0, 196, 0, 220, 0, 196, 175, 0, 175
};

const uint16_t SONG_DUR_MS[] PROGMEM = {
  331, 106, 72, 145, 469, 179, 79, 140, 874, 2360, 2000, 290, 140, 256, 181, 251,
  186, 251, 179, 362, 72, 258, 181, 285, 145, 256, 179, 367, 68, 79, 138, 1889,
  2000, 220, 102, 469, 183, 362, 75, 106, 77, 577, 106, 111, 106, 584, 70, 145,
  72, 1302, 217, 215, 222, 254, 179, 292, 149, 290, 145, 70, 143, 2319, 507, 181,
  254, 258, 177, 111, 106, 403, 249, 326, 113, 140, 36, 618, 70, 326, 104, 328,
  109, 111, 111, 469, 181, 1886, 285, 292, 147, 256, 102, 326, 181, 186, 251, 362,
  72, 399, 36, 326, 106, 403, 41, 394, 34, 72, 145, 543, 109, 2176, 2000, 258,
  147, 217, 254, 251, 183, 215, 220, 215, 192, 204, 5, 498, 188, 75, 140, 328,
  111, 70, 143, 111, 111, 541, 109, 1633, 539, 195, 211, 251, 220, 251, 179, 220,
  181, 358, 111, 362, 70, 149, 68, 111, 75, 360, 541, 147, 70, 582, 72, 186,
  179, 68, 1852, 294, 317, 113, 2570, 36, 399, 36, 365, 109, 68, 145, 75, 111,
  179, 181, 38, 288, 183, 1664, 512, 2061, 109, 220, 34, 616, 217, 2754, 978, 111,
  104, 254, 147, 580, 38, 433, 38, 686, 183, 285, 149, 254, 181, 145, 111, 392,
  618, 41, 215, 143, 72, 2645, 2000, 106, 86, 460, 215, 365, 75, 104, 111, 546,
  106, 111, 72, 614, 75, 140, 70, 1273, 251, 215, 224, 249, 181, 294, 140, 294,
  138, 82, 143, 2314, 510, 181, 256, 251, 186, 104, 109, 433, 217, 328, 102, 152,
  75, 580, 70, 326, 109, 326, 111, 106, 104, 478, 181, 1884, 2000, 181, 34, 181,
  435, 41, 174, 34, 186, 32, 1492, 2000, 2572, 34, 401, 36, 360, 111, 68, 145,
  72, 111, 179, 183, 38, 288, 186, 1660, 510, 29, 2000, 217, 654, 32, 186, 2751,
  978, 115, 104, 251, 145, 580, 36, 435, 41, 688, 177, 290, 147, 249, 183, 145,
  109, 399, 618, 34, 224, 136, 70, 2625
};

const uint16_t SONG_GATE_MS[] PROGMEM = {
  298, 0, 65, 0, 422, 0, 71, 0, 787, 2124, 0, 261, 0, 230, 0, 226,
  0, 226, 0, 326, 0, 232, 0, 257, 0, 230, 0, 330, 0, 71, 0, 1700,
  0, 198, 0, 422, 0, 326, 0, 96, 0, 520, 0, 100, 0, 526, 0, 130,
  0, 1172, 0, 194, 0, 228, 0, 263, 0, 261, 0, 63, 0, 2087, 0, 163,
  0, 232, 0, 100, 0, 363, 0, 293, 0, 126, 0, 556, 0, 293, 0, 296,
  0, 100, 0, 422, 0, 1698, 0, 263, 0, 230, 0, 293, 0, 167, 0, 326,
  0, 359, 0, 293, 0, 363, 0, 355, 0, 65, 0, 489, 0, 1959, 0, 232,
  0, 196, 0, 226, 0, 194, 0, 194, 0, 183, 0, 448, 0, 67, 0, 296,
  0, 63, 0, 100, 0, 487, 0, 1469, 0, 175, 0, 226, 0, 226, 0, 198,
  0, 322, 0, 326, 0, 135, 0, 100, 0, 324, 0, 132, 0, 524, 0, 167,
  161, 0, 1667, 0, 285, 0, 2313, 0, 359, 0, 328, 0, 61, 0, 67, 0,
  161, 163, 0, 259, 0, 1498, 0, 1855, 0, 198, 0, 554, 196, 0, 2478, 0,
  100, 0, 228, 0, 522, 0, 389, 0, 618, 0, 257, 0, 228, 0, 130, 0, 353,
  556, 0, 194, 128, 0, 2380, 0, 96, 0, 414, 0, 328, 0, 94, 0, 491,
  0, 100, 0, 552, 0, 126, 0, 1145, 0, 194, 0, 224, 0, 265, 0, 265,
  0, 73, 0, 2083, 0, 163, 0, 226, 0, 94, 0, 389, 0, 296, 0, 137,
  0, 522, 0, 293, 0, 293, 0, 96, 0, 430, 0, 1696, 0, 163, 0, 163,
  391, 0, 157, 0, 167, 0, 1343, 0, 2315, 0, 361, 0, 324, 0, 61, 0, 65,
  0, 161, 165, 0, 259, 0, 1494, 0, 30, 0, 196, 589, 0, 167, 0, 2476,
  0, 104, 0, 226, 0, 522, 0, 391, 0, 620, 0, 261, 0, 224, 0, 130, 0, 359,
  556, 0, 202, 122, 0, 2362
};

static uint16_t scaleMs(uint16_t ms) {
  // SPEED_PCT = 100 => unchanged
  return (uint32_t)ms * (uint32_t)SPEED_PCT / 100UL;
}

static uint16_t applyTranspose(uint16_t baseHz) {
  if (baseHz == 0 || TRANSPOSE == 0) return baseHz;
  int8_t t = TRANSPOSE;
  if (t < -12) t = -12;
  if (t >  12) t =  12;
  uint8_t idx = (uint8_t)(t + 12);
  uint32_t mul = pgm_read_dword(&SEMI_MUL_Q16[idx]);
  uint32_t hz  = ((uint32_t)baseHz * mul) >> 16;
  if (hz < 31)   hz = 31;   // tone() gets weird below ~31 Hz
  if (hz > 20000) hz = 20000;
  return (uint16_t)hz;
}

void setup() {
  pinMode(BUZZ_PIN, OUTPUT);
  noTone(BUZZ_PIN);
}

void loop() {
  for (uint16_t i = 0; i < N_EVENTS; i++) {
    uint16_t freq = pgm_read_word(&SONG_FREQ_HZ[i]);
    uint16_t dur  = pgm_read_word(&SONG_DUR_MS[i]);
    uint16_t gate = pgm_read_word(&SONG_GATE_MS[i]);

    dur  = scaleMs(dur);
    gate = scaleMs(gate);
    if (gate > dur) gate = dur;

    if (freq == 0) {
      noTone(BUZZ_PIN);
      delay(dur);
      continue;
    }

    freq = applyTranspose(freq);

    // Gate (tone on), then the remainder as silence (tone off).
    if (gate > 0) {
      tone(BUZZ_PIN, freq);
      delay(gate);
    }
    noTone(BUZZ_PIN);

    uint16_t offMs = dur - gate;
    if (offMs > 0) delay(offMs);

    if (EXTRA_GAP_MS) delay(EXTRA_GAP_MS);
  }

  delay(2000); // pause before repeating
}
