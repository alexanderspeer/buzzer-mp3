/*
  3-Button, 3-Song Buzzer Player (Arduino Nano)

  Buttons:
    A1 toggles Song 1
    A2 toggles Song 2
    A3 toggles Song 3

  Behavior:
  - Press Ax to start that song (plays through, then stops).
  - Press the SAME button again while that song is playing: stops immediately.
  - Press a DIFFERENT button while a song is playing: stops current and switches to new song.

  Wiring:
  - Buttons wired from Ax pin to GND (uses INPUT_PULLUP, so pressed = LOW)
  - Passive buzzer on D9 (BUZZ_PIN)

  You will paste 3 song data chunks where indicated.
  Each chunk must define:
    const uint16_t N_EVENTS_SONGx;
    const uint16_t SONGx_FREQ_HZ[] PROGMEM;
    const uint16_t SONGx_DUR_MS[]  PROGMEM;
    const uint16_t SONGx_GATE_MS[] PROGMEM;
*/

#include <Arduino.h>
#include <avr/pgmspace.h>

const uint8_t BUZZ_PIN = 9;

const uint8_t BTN1_PIN = A1;
const uint8_t BTN2_PIN = A2;
const uint8_t BTN3_PIN = A3;

// Playback tuning
const uint16_t SPEED_PCT = 100;    // 100 = original timing
const uint8_t  EXTRA_GAP_MS = 2;   // small gap after each event

// Debounce
const uint16_t DEBOUNCE_MS = 35;

const uint16_t N_EVENTS_SONG1 = 328;

// 0 freq means rest. Arrays aligned by event index.
const uint16_t SONG1_FREQ_HZ[] PROGMEM = {
  262, 0, 262, 0, 262, 0, 262, 0, 262, 247, 0, 262, 0, 294, 0, 262,
  0, 294, 0, 262, 0, 294, 0, 262, 0, 294, 0, 262, 0, 294, 0, 262,
  0, 330, 0, 330, 0, 330, 0, 349, 0, 392, 0, 392, 0, 392, 0, 349,
  0, 330, 0, 330, 0, 330, 0, 330, 0, 330, 0, 330, 0, 349, 0, 349,
  0, 349, 0, 349, 0, 349, 0, 349, 0, 392, 0, 330, 0, 330, 0, 330,
  0, 330, 0, 349, 0, 349, 0, 349, 0, 349, 0, 349, 0, 349, 0, 349,
  0, 392, 0, 330, 0, 330, 0, 330, 0, 349, 0, 349, 0, 349, 0, 349,
  0, 349, 0, 349, 0, 349, 0, 349, 0, 349, 0, 330, 0, 330, 0, 330,
  0, 330, 0, 330, 0, 349, 0, 349, 0, 349, 0, 349, 0, 349, 0, 349,
  0, 349, 0, 392, 0, 330, 0, 349, 0, 330, 0, 294, 0, 349, 0, 330,
  294, 0, 262, 0, 220, 0, 262, 0, 247, 0, 220, 0, 196, 0, 196, 0,
  196, 220, 0, 196, 0, 147, 0, 262, 0, 262, 0, 247, 220, 196, 0, 233,
  0, 233, 0, 233, 0, 262, 0, 220, 0, 220, 0, 220, 0, 196, 0, 196,
  220, 0, 196, 175, 0, 175, 0, 330, 0, 330, 0, 330, 0, 349, 0, 392,
  0, 392, 0, 392, 0, 349, 0, 330, 0, 330, 0, 330, 0, 330, 0, 330,
  0, 330, 0, 349, 0, 349, 0, 349, 0, 349, 0, 349, 0, 349, 0, 392,
  0, 330, 0, 330, 0, 330, 0, 330, 0, 349, 0, 349, 0, 294, 0, 349,
  349, 0, 330, 0, 294, 0, 262, 0, 262, 0, 247, 0, 220, 0, 196, 0,
  196, 0, 196, 220, 0, 196, 0, 147, 0, 262, 0, 262, 247, 0, 220, 196,
  0, 233, 0, 233, 0, 233, 0, 262, 0, 220, 0, 220, 0, 220, 0, 196,
  0, 196, 220, 0, 196, 175, 0, 175
};

const uint16_t SONG1_DUR_MS[] PROGMEM = {
  331, 106, 72, 145, 469, 179, 79, 140, 874, 2360, 2000, 290, 140, 256, 181, 251,
  186, 251, 179, 362, 72, 258, 181, 285, 145, 256, 179, 367, 68, 79, 138, 1889,
  2000, 220, 102, 469, 183, 362, 75, 106, 77, 577, 106, 111, 106, 584, 70, 145,
  72, 1302, 217, 215, 222, 254, 179, 292, 149, 290, 145, 70, 143, 2319, 507, 181,
  254, 258, 177, 111, 106, 403, 249, 326, 113, 140, 36, 618, 70, 326, 104, 328,
  109, 111, 111, 469, 181, 1886, 285, 292, 147, 256, 102, 326, 181, 186, 251, 362,
  72, 399, 36, 326, 106, 403, 41, 394, 34, 72, 145, 543, 109, 2176, 2000, 258,
  147, 217, 254, 251, 183, 215, 220, 215, 192, 204, 5, 498, 188, 75, 140, 328,
  111, 70, 143, 111, 111, 541, 109, 1633, 539, 195, 211, 251, 220, 251, 179, 220,
  181, 358, 111, 362, 70, 149, 68, 111, 75, 360, 541, 147, 70, 582, 72, 186,
  179, 68, 1852, 294, 317, 113, 2570, 36, 399, 36, 365, 109, 68, 145, 75, 111,
  179, 181, 38, 288, 183, 1664, 512, 2061, 109, 220, 34, 616, 217, 2754, 978, 111,
  104, 254, 147, 580, 38, 433, 38, 686, 183, 285, 149, 254, 181, 145, 111, 392,
  618, 41, 215, 143, 72, 2645, 2000, 106, 86, 460, 215, 365, 75, 104, 111, 546,
  106, 111, 72, 614, 75, 140, 70, 1273, 251, 215, 224, 249, 181, 294, 140, 294,
  138, 82, 143, 2314, 510, 181, 256, 251, 186, 104, 109, 433, 217, 328, 102, 152,
  75, 580, 70, 326, 109, 326, 111, 106, 104, 478, 181, 1884, 2000, 181, 34, 181,
  435, 41, 174, 34, 186, 32, 1492, 2000, 2572, 34, 401, 36, 360, 111, 68, 145,
  72, 111, 179, 183, 38, 288, 186, 1660, 510, 29, 2000, 217, 654, 32, 186, 2751,
  978, 115, 104, 251, 145, 580, 36, 435, 41, 688, 177, 290, 147, 249, 183, 145,
  109, 399, 618, 34, 224, 136, 70, 2625
};

const uint16_t SONG1_GATE_MS[] PROGMEM = {
  298, 0, 65, 0, 422, 0, 71, 0, 787, 2124, 0, 261, 0, 230, 0, 226,
  0, 226, 0, 326, 0, 232, 0, 257, 0, 230, 0, 330, 0, 71, 0, 1700,
  0, 198, 0, 422, 0, 326, 0, 96, 0, 520, 0, 100, 0, 526, 0, 130,
  0, 1172, 0, 194, 0, 228, 0, 263, 0, 261, 0, 63, 0, 2087, 0, 163,
  0, 232, 0, 100, 0, 363, 0, 293, 0, 126, 0, 556, 0, 293, 0, 296,
  0, 100, 0, 422, 0, 1698, 0, 263, 0, 230, 0, 293, 0, 167, 0, 326,
  0, 359, 0, 293, 0, 363, 0, 355, 0, 65, 0, 489, 0, 1959, 0, 232,
  0, 196, 0, 226, 0, 194, 0, 194, 0, 183, 0, 448, 0, 67, 0, 296,
  0, 63, 0, 100, 0, 487, 0, 1469, 0, 175, 0, 226, 0, 226, 0, 198,
  0, 322, 0, 326, 0, 135, 0, 100, 0, 324, 0, 132, 0, 524, 0, 167,
  161, 0, 1667, 0, 285, 0, 2313, 0, 359, 0, 328, 0, 61, 0, 67, 0,
  161, 163, 0, 259, 0, 1498, 0, 1855, 0, 198, 0, 554, 196, 2478, 0, 100,
  0, 228, 0, 522, 0, 389, 0, 618, 0, 257, 0, 228, 0, 130, 0, 353,
  556, 0, 194, 128, 0, 2380, 0, 96, 0, 414, 0, 328, 0, 94, 0, 491,
  0, 100, 0, 552, 0, 126, 0, 1145, 0, 194, 0, 224, 0, 265, 0, 265,
  0, 73, 0, 2083, 0, 163, 0, 226, 0, 94, 0, 389, 0, 296, 0, 137,
  0, 522, 0, 293, 0, 293, 0, 96, 0, 430, 0, 1696, 0, 163, 0, 163,
  391, 0, 157, 0, 167, 0, 1343, 0, 2315, 0, 361, 0, 324, 0, 61, 0,
  65, 0, 161, 165, 0, 259, 0, 1494, 0, 30, 0, 196, 589, 0, 167, 2476,
  0, 104, 0, 226, 0, 522, 0, 391, 0, 620, 0, 261, 0, 224, 0, 130,
  0, 359, 556, 0, 202, 122, 0, 2362
};



// =======================================================
// >>>>>> PASTE SONG 2 ARRAYS HERE <<<<<<
// =======================================================
// Generated from: Barry_Manilow_-_Mandy.mid
// Track: Melody
// Total events (notes + rests): 115

const uint16_t N_EVENTS_SONG2 = 115;

// 0 freq means rest. Arrays aligned by event index.
const uint16_t SONG2_FREQ_HZ[] PROGMEM = {
  349, 392, 466, 392, 587, 392, 349, 349, 392, 466, 392, 587, 392, 349, 622, 587,
  587, 523, 523, 392, 622, 587, 523, 622, 698, 622, 587, 523, 622, 587, 523, 587,
  523, 466, 392, 349, 392, 466, 392, 587, 392, 349, 349, 392, 466, 392, 523, 587,
  392, 349, 622, 587, 587, 523, 523, 392, 587, 622, 587, 523, 622, 698, 622, 587,
  523, 392, 622, 587, 523, 622, 698, 587, 523, 466, 349, 587, 523, 466, 587, 523,
  466, 523, 523, 349, 349, 349, 622, 587, 622, 587, 523, 587, 523, 466, 349, 587,
  523, 466, 587, 0, 523, 466, 587, 523, 349, 349, 349, 622, 587, 622, 587, 523,
  587, 523, 466
};

const uint16_t SONG2_DUR_MS[] PROGMEM = {
  264, 322, 288, 269, 577, 308, 2538, 303, 288, 298, 264, 562, 312, 2572, 418, 361,
  168, 236, 846, 303, 312, 553, 1418, 370, 534, 130, 125, 1202, 327, 288, 308, 519,
  303, 284, 279, 279, 284, 298, 255, 611, 284, 2615, 269, 312, 288, 298, 87, 466,
  322, 2572, 413, 356, 144, 221, 846, 279, 288, 288, 288, 1192, 591, 558, 144, 135,
  856, 308, 303, 288, 298, 543, 288, 298, 601, 1154, 288, 303, 615, 288, 288, 591,
  288, 288, 591, 1442, 288, 288, 288, 288, 288, 577, 288, 317, 625, 1168, 288, 288,
  582, 288, 284, 5, 620, 288, 288, 577, 1442, 288, 288, 303, 288, 317, 337, 288,
  577, 577, 8942
};

const uint16_t SONG2_GATE_MS[] PROGMEM = {
  238, 290, 260, 242, 519, 277, 2285, 273, 260, 268, 238, 506, 281, 2315, 376, 325,
  151, 212, 762, 273, 281, 498, 1276, 333, 480, 117, 112, 1082, 294, 260, 277, 467,
  273, 255, 251, 251, 255, 268, 229, 550, 255, 2354, 242, 281, 260, 268, 78, 420,
  290, 2315, 372, 320, 130, 199, 762, 251, 260, 260, 260, 1073, 532, 502, 130, 121,
  770, 277, 273, 260, 268, 489, 260, 268, 541, 1038, 260, 273, 554, 260, 260, 532,
  260, 260, 532, 1298, 260, 260, 260, 260, 260, 519, 260, 286, 562, 1051, 260, 260,
  524, 260, 255, 0, 558, 260, 260, 519, 1298, 260, 260, 273, 260, 286, 303, 260,
  519, 519, 8048
};



// =======================================================
// >>>>>> PASTE SONG 3 ARRAYS HERE <<<<<<
// =======================================================
// Generated from: Kenny_Rogers_-_The_Gambler.mid
// Track: MELODY
// Total events (notes + rests): 824

const uint16_t N_EVENTS_SONG3 = 824;

// 0 freq means rest. Arrays aligned by event index.
const uint16_t SONG3_FREQ_HZ[] PROGMEM = {
  311, 0, 311, 0, 311, 0, 311, 0, 311, 0, 311, 0, 311, 0, 311, 0,
  415, 0, 415, 0, 466, 0, 523, 0, 466, 0, 392, 0, 466, 0, 523, 0,
  466, 0, 392, 0, 392, 0, 311, 0, 311, 0, 311, 0, 311, 0, 349, 0,
  311, 0, 311, 0, 311, 0, 311, 0, 311, 0, 311, 0, 415, 0, 415, 0,
  466, 0, 523, 0, 466, 0, 392, 0, 415, 0, 466, 0, 523, 0, 466, 0,
  392, 0, 392, 0, 349, 0, 349, 0, 392, 0, 349, 0, 311, 0, 311, 0,
  311, 0, 311, 0, 311, 0, 311, 0, 311, 0, 415, 0, 415, 0, 466, 0,
  523, 0, 466, 0, 392, 0, 466, 0, 523, 0, 466, 0, 392, 0, 392, 0,
  311, 0, 311, 0, 311, 0, 311, 0, 349, 0, 311, 0, 311, 0, 311, 0,
  311, 0, 311, 0, 311, 0, 415, 0, 415, 0, 466, 0, 523, 0, 466, 0,
  392, 0, 415, 0, 466, 0, 523, 0, 466, 0, 392, 0, 392, 0, 349, 0,
  349, 0, 392, 0, 349, 0, 311, 0, 311, 0, 311, 0, 311, 0, 311, 0,
  311, 0, 311, 0, 311, 0, 415, 0, 415, 0, 466, 0, 523, 0, 466, 0,
  392, 0, 466, 0, 523, 0, 466, 0, 392, 0, 392, 0, 311, 0, 311, 0,
  311, 0, 311, 0, 349, 0, 311, 0, 311, 0, 311, 0, 311, 0, 311, 0,
  311, 0, 415, 0, 415, 0, 466, 0, 523, 0, 466, 0, 392, 0, 415, 0,
  466, 0, 523, 0, 466, 0, 392, 0, 392, 0, 349, 0, 349, 0, 392, 0,
  349, 0, 311, 311, 0, 311, 0, 311, 0, 311, 0, 311, 0, 311, 0, 311,
  0, 311, 0, 415, 0, 466, 0, 523, 0, 466, 0, 392, 0, 415, 0, 466,
  0, 523, 0, 466, 0, 392, 0, 311, 0, 294, 0, 311, 0, 349, 0, 392,
  0, 349, 0, 349, 0, 311, 0, 349, 0, 311, 0, 311, 0, 415, 0, 415,
  0, 466, 0, 523, 0, 466, 0, 392, 0, 392, 0, 466, 0, 466, 0, 523,
  0, 466, 0, 466, 0, 392, 0, 349, 0, 349, 0, 392, 294, 0, 311, 0,
  330, 0, 330, 0, 330, 0, 330, 0, 330, 0, 330, 0, 440, 0, 440, 0,
  494, 0, 554, 0, 494, 0, 415, 0, 494, 0, 554, 0, 494, 0, 415, 0,
  415, 0, 330, 0, 330, 0, 330, 0, 330, 0, 370, 0, 330, 0, 330, 0,
  330, 0, 330, 0, 330, 0, 330, 0, 440, 0, 440, 0, 494, 0, 554, 0,
  494, 0, 415, 0, 440, 0, 494, 0, 554, 0, 494, 0, 415, 0, 415, 0,
  370, 0, 370, 0, 415, 0, 370, 0, 330, 0, 330, 0, 330, 0, 330, 0,
  330, 0, 330, 0, 330, 0, 440, 0, 440, 0, 494, 0, 554, 0, 494, 0,
  415, 0, 494, 0, 554, 0, 494, 0, 415, 0, 415, 0, 330, 0, 330, 0,
  330, 0, 330, 0, 370, 0, 330, 0, 330, 0, 330, 0, 330, 0, 330, 0,
  330, 0, 440, 0, 440, 0, 494, 0, 554, 0, 494, 0, 415, 0, 440, 0,
  494, 0, 554, 0, 494, 0, 415, 0, 415, 0, 370, 0, 370, 0, 415, 0,
  370, 0, 330, 330, 0, 330, 0, 330, 0, 330, 0, 330, 0, 330, 0, 330,
  0, 330, 0, 440, 0, 494, 0, 554, 0, 494, 0, 415, 0, 440, 0, 494,
  0, 554, 0, 494, 0, 415, 0, 330, 0, 311, 0, 330, 0, 370, 0, 415,
  0, 370, 0, 370, 0, 330, 0, 370, 0, 330, 0, 330, 0, 440, 0, 440,
  0, 494, 0, 554, 0, 494, 0, 415, 0, 415, 0, 494, 0, 494, 0, 554,
  0, 494, 0, 494, 0, 415, 0, 370, 0, 370, 0, 415, 311, 0, 330, 0,
  415, 0, 370, 0, 370, 0, 330, 0, 330, 0, 330, 0, 330, 0, 330, 0,
  440, 0, 494, 0, 554, 0, 494, 0, 415, 0, 440, 0, 494, 0, 554, 0,
  494, 0, 415, 0, 330, 0, 311, 0, 330, 0, 370, 0, 415, 0, 370, 0,
  370, 0, 330, 0, 370, 0, 330, 0, 330, 0, 440, 0, 440, 0, 494, 0,
  554, 0, 494, 0, 415, 0, 415, 0, 494, 0, 494, 0, 554, 0, 494, 0,
  494, 0, 415, 0, 370, 0, 370, 0, 415, 311, 0, 330, 0, 415, 0, 370,
  0, 370, 0, 330, 0, 330, 0, 330, 0, 330, 0, 330, 0, 440, 0, 494,
  0, 554, 0, 494, 0, 415, 0, 440, 0, 494, 0, 554, 0, 494, 0, 415,
  0, 330, 0, 311, 0, 330, 0, 370, 0, 415, 0, 370, 0, 370, 0, 330,
  0, 370, 0, 330, 0, 330, 0, 440, 0, 440, 0, 494, 0, 554, 0, 494,
  0, 415, 0, 415, 0, 494, 0, 494, 0, 554, 0, 494, 0, 494, 0, 415,
  0, 370, 0, 370, 0, 415, 311, 330
};

const uint16_t SONG3_DUR_MS[] PROGMEM = {
  86, 81, 83, 83, 542, 125, 203, 131, 67, 100, 292, 208, 553, 114, 214, 119,
  150, 183, 253, 81, 128, 206, 83, 83, 481, 19, 878, 456, 181, 153, 442, 58,
  419, 81, 511, 156, 283, 50, 144, 189, 164, 169, 206, 128, 133, 33, 1036, 131,
  114, 219, 550, 117, 367, 133, 364, 136, 497, 169, 303, 31, 142, 192, 272, 61,
  253, 81, 103, 64, 458, 42, 969, 364, 325, 8, 297, 36, 156, 11, 467, 33,
  569, 97, 331, 3, 108, 225, 275, 58, 275, 58, 128, 39, 886, 614, 542, 125,
  203, 131, 67, 100, 292, 208, 553, 114, 214, 119, 150, 183, 253, 81, 128, 206,
  83, 83, 481, 19, 878, 456, 181, 153, 442, 58, 419, 81, 511, 156, 283, 50,
  144, 189, 164, 169, 206, 128, 133, 33, 1036, 131, 114, 219, 550, 117, 367, 133,
  364, 136, 497, 169, 303, 31, 142, 192, 272, 61, 253, 81, 103, 64, 458, 42,
  969, 364, 325, 8, 297, 36, 156, 11, 467, 33, 569, 97, 331, 3, 108, 225,
  275, 58, 275, 58, 128, 39, 886, 1614, 211, 122, 542, 125, 203, 131, 67, 100,
  292, 208, 553, 114, 214, 119, 150, 183, 253, 81, 128, 206, 83, 83, 481, 19,
  878, 456, 181, 153, 442, 58, 419, 81, 511, 156, 283, 50, 144, 189, 164, 169,
  206, 128, 133, 33, 1036, 131, 114, 219, 550, 117, 367, 133, 364, 136, 497, 169,
  303, 31, 142, 192, 272, 61, 253, 81, 103, 64, 458, 42, 969, 364, 325, 8,
  297, 36, 156, 11, 467, 33, 569, 97, 331, 3, 108, 225, 275, 58, 275, 58,
  128, 39, 833, 53, 114, 111, 222, 78, 89, 544, 122, 194, 139, 78, 89, 311,
  189, 675, 658, 256, 78, 147, 186, 108, 58, 472, 28, 992, 342, 269, 64, 142,
  192, 117, 50, 414, 86, 1056, 278, 308, 25, 267, 67, 153, 14, 733, 100, 108,
  58, 194, 139, 61, 106, 606, 61, 386, 114, 906, 261, 167, 167, 158, 175, 147,
  186, 206, 128, 111, 56, 456, 44, 478, 189, 94, 239, 364, 136, 100, 67, 236,
  97, 86, 81, 367, 133, 942, 392, 89, 78, 106, 61, 344, 244, 89, 1725, 3000,
  542, 125, 203, 131, 67, 100, 292, 208, 553, 114, 214, 119, 150, 183, 253, 81,
  128, 206, 83, 83, 481, 19, 878, 456, 181, 153, 442, 58, 419, 81, 511, 156,
  283, 50, 144, 189, 164, 169, 206, 128, 133, 33, 1036, 131, 114, 219, 550, 117,
  367, 133, 364, 136, 497, 169, 303, 31, 142, 192, 272, 61, 253, 81, 103, 64,
  458, 42, 969, 364, 325, 8, 297, 36, 156, 11, 467, 33, 569, 97, 331, 3,
  108, 225, 275, 58, 275, 58, 128, 39, 886, 614, 542, 125, 203, 131, 67, 100,
  292, 208, 553, 114, 214, 119, 150, 183, 253, 81, 128, 206, 83, 83, 481, 19,
  878, 456, 181, 153, 442, 58, 419, 81, 511, 156, 283, 50, 144, 189, 164, 169,
  206, 128, 133, 33, 1036, 131, 114, 219, 550, 117, 367, 133, 364, 136, 497, 169,
  303, 31, 142, 192, 272, 61, 253, 81, 103, 64, 458, 42, 969, 364, 325, 8,
  297, 36, 156, 11, 467, 33, 569, 97, 331, 3, 108, 225, 275, 58, 275, 58,
  128, 39, 833, 53, 114, 111, 222, 78, 89, 544, 122, 194, 139, 78, 89, 311,
  189, 675, 658, 256, 78, 147, 186, 108, 58, 472, 28, 992, 342, 269, 64, 142,
  192, 117, 50, 414, 86, 1056, 278, 308, 25, 267, 67, 153, 14, 733, 100, 108,
  58, 194, 139, 61, 106, 606, 61, 386, 114, 906, 261, 167, 167, 158, 175, 147,
  186, 206, 128, 111, 56, 456, 44, 478, 189, 94, 239, 364, 136, 100, 67, 236,
  97, 86, 81, 367, 133, 942, 392, 89, 78, 106, 61, 344, 244, 89, 392, 275,
  156, 11, 267, 67, 94, 72, 544, 122, 194, 139, 78, 89, 311, 189, 675, 658,
  256, 78, 147, 186, 108, 58, 472, 28, 992, 342, 269, 64, 142, 192, 117, 50,
  414, 86, 1056, 278, 308, 25, 267, 67, 153, 14, 733, 100, 108, 58, 194, 139,
  61, 106, 606, 61, 386, 114, 906, 261, 167, 167, 158, 175, 147, 186, 206, 128,
  111, 56, 456, 44, 478, 189, 94, 239, 364, 136, 100, 67, 236, 97, 86, 81,
  367, 133, 942, 392, 89, 78, 106, 61, 344, 244, 89, 392, 275, 125, 42, 158,
  175, 86, 81, 544, 122, 194, 139, 78, 89, 311, 189, 675, 658, 256, 78, 147,
  186, 108, 58, 472, 28, 992, 342, 269, 64, 142, 192, 117, 50, 414, 86, 1056,
  278, 308, 25, 267, 67, 153, 14, 733, 100, 108, 58, 194, 139, 61, 106, 606,
  61, 386, 114, 906, 261, 167, 167, 158, 175, 147, 186, 206, 128, 111, 56, 456,
  44, 478, 189, 94, 239, 364, 136, 100, 67, 236, 97, 86, 81, 367, 133, 942,
  392, 89, 78, 106, 61, 344, 167, 4589
};

const uint16_t SONG3_GATE_MS[] PROGMEM = {
  77, 0, 75, 0, 487, 0, 182, 0, 60, 0, 262, 0, 497, 0, 192, 0,
  135, 0, 227, 0, 115, 0, 75, 0, 432, 0, 790, 0, 162, 0, 397, 0,
  377, 0, 460, 0, 255, 0, 130, 0, 147, 0, 185, 0, 120, 0, 932, 0,
  102, 0, 495, 0, 330, 0, 327, 0, 447, 0, 272, 0, 127, 0, 245, 0,
  227, 0, 92, 0, 412, 0, 872, 0, 292, 0, 267, 0, 140, 0, 420, 0,
  512, 0, 297, 0, 97, 0, 247, 0, 247, 0, 115, 0, 797, 0, 487, 0,
  182, 0, 60, 0, 262, 0, 497, 0, 192, 0, 135, 0, 227, 0, 115, 0,
  75, 0, 432, 0, 790, 0, 162, 0, 397, 0, 377, 0, 460, 0, 255, 0,
  130, 0, 147, 0, 185, 0, 120, 0, 932, 0, 102, 0, 495, 0, 330, 0,
  327, 0, 447, 0, 272, 0, 127, 0, 245, 0, 227, 0, 92, 0, 412, 0,
  872, 0, 292, 0, 267, 0, 140, 0, 420, 0, 512, 0, 297, 0, 97, 0,
  247, 0, 247, 0, 115, 0, 797, 0, 190, 0, 487, 0, 182, 0, 60, 0,
  262, 0, 497, 0, 192, 0, 135, 0, 227, 0, 115, 0, 75, 0, 432, 0,
  790, 0, 162, 0, 397, 0, 377, 0, 460, 0, 255, 0, 130, 0, 147, 0,
  185, 0, 120, 0, 932, 0, 102, 0, 495, 0, 330, 0, 327, 0, 447, 0,
  272, 0, 127, 0, 245, 0, 227, 0, 92, 0, 412, 0, 872, 0, 292, 0,
  267, 0, 140, 0, 420, 0, 512, 0, 297, 0, 97, 0, 247, 0, 247, 0,
  115, 0, 750, 47, 0, 100, 0, 70, 0, 490, 0, 175, 0, 70, 0, 280,
  0, 607, 0, 230, 0, 132, 0, 97, 0, 425, 0, 892, 0, 242, 0, 127,
  0, 105, 0, 372, 0, 950, 0, 277, 0, 240, 0, 137, 0, 660, 0, 97,
  0, 175, 0, 55, 0, 545, 0, 347, 0, 815, 0, 150, 0, 142, 0, 132,
  0, 185, 0, 100, 0, 410, 0, 430, 0, 85, 0, 327, 0, 90, 0, 212,
  0, 77, 0, 330, 0, 847, 0, 80, 0, 95, 0, 310, 220, 0, 1552, 0,
  487, 0, 182, 0, 60, 0, 262, 0, 497, 0, 192, 0, 135, 0, 227, 0,
  115, 0, 75, 0, 432, 0, 790, 0, 162, 0, 397, 0, 377, 0, 460, 0,
  255, 0, 130, 0, 147, 0, 185, 0, 120, 0, 932, 0, 102, 0, 495, 0,
  330, 0, 327, 0, 447, 0, 272, 0, 127, 0, 245, 0, 227, 0, 92, 0,
  412, 0, 872, 0, 292, 0, 267, 0, 140, 0, 420, 0, 512, 0, 297, 0,
  97, 0, 247, 0, 247, 0, 115, 0, 797, 0, 487, 0, 182, 0, 60, 0,
  262, 0, 497, 0, 192, 0, 135, 0, 227, 0, 115, 0, 75, 0, 432, 0,
  790, 0, 162, 0, 397, 0, 377, 0, 460, 0, 255, 0, 130, 0, 147, 0,
  185, 0, 120, 0, 932, 0, 102, 0, 495, 0, 330, 0, 327, 0, 447, 0,
  272, 0, 127, 0, 245, 0, 227, 0, 92, 0, 412, 0, 872, 0, 292, 0,
  267, 0, 140, 0, 420, 0, 512, 0, 297, 0, 97, 0, 247, 0, 247, 0,
  115, 0, 750, 47, 0, 100, 0, 70, 0, 490, 0, 175, 0, 70, 0, 280,
  0, 607, 0, 230, 0, 132, 0, 97, 0, 425, 0, 892, 0, 242, 0, 127,
  0, 105, 0, 372, 0, 950, 0, 277, 0, 240, 0, 137, 0, 660, 0, 97,
  0, 175, 0, 55, 0, 545, 0, 347, 0, 815, 0, 150, 0, 142, 0, 132,
  0, 185, 0, 100, 0, 410, 0, 430, 0, 85, 0, 327, 0, 90, 0, 212,
  0, 77, 0, 330, 0, 847, 0, 80, 0, 95, 0, 310, 220, 0, 352, 0,
  140, 0, 240, 0, 85, 0, 490, 0, 175, 0, 70, 0, 280, 0, 607, 0,
  230, 0, 132, 0, 97, 0, 425, 0, 892, 0, 242, 0, 127, 0, 105, 0,
  372, 0, 950, 0, 277, 0, 240, 0, 137, 0, 660, 0, 97, 0, 175, 0,
  55, 0, 545, 0, 347, 0, 815, 0, 150, 0, 142, 0, 132, 0, 185, 0,
  100, 0, 410, 0, 430, 0, 85, 0, 327, 0, 90, 0, 212, 0, 77, 0,
  330, 0, 847, 0, 80, 0, 95, 0, 310, 220, 0, 352, 0, 112, 0, 142,
  0, 77, 0, 490, 0, 175, 0, 70, 0, 280, 0, 607, 0, 230, 0, 132,
  0, 97, 0, 425, 0, 892, 0, 242, 0, 127, 0, 105, 0, 372, 0, 950,
  0, 277, 0, 240, 0, 137, 0, 660, 0, 97, 0, 175, 0, 55, 0, 545,
  0, 347, 0, 815, 0, 150, 0, 142, 0, 132, 0, 185, 0, 100, 0, 410,
  0, 430, 0, 85, 0, 327, 0, 90, 0, 212, 0, 77, 0, 330, 0, 847,
  0, 80, 0, 95, 0, 310, 150, 4130
};


// =======================================================
// Internal state
// =======================================================

enum SongId : uint8_t { SONG_NONE = 0, SONG_1 = 1, SONG_2 = 2, SONG_3 = 3 };

static SongId currentSong = SONG_NONE;
static bool isPlaying = false;
static volatile bool stopRequested = false;

// Debounce state for each button
static bool stable1 = false, stable2 = false, stable3 = false; // debounced "pressed" state
static bool raw1 = false, raw2 = false, raw3 = false;          // last raw pressed reading
static uint32_t lastChange1 = 0, lastChange2 = 0, lastChange3 = 0;

static uint16_t scaleMs(uint16_t ms) {
  return (uint32_t)ms * (uint32_t)SPEED_PCT / 100UL;
}

// Returns true once per debounced press edge (not pressed -> pressed).
static bool pressedEdge(uint8_t pin, bool &stablePressed, bool &lastRawPressed, uint32_t &lastChangeMs) {
  bool rawPressed = (digitalRead(pin) == LOW); // INPUT_PULLUP: LOW means pressed

  if (rawPressed != lastRawPressed) {
    lastRawPressed = rawPressed;
    lastChangeMs = millis();
  }

  if ((millis() - lastChangeMs) > DEBOUNCE_MS) {
    if (stablePressed != rawPressed) {
      stablePressed = rawPressed;
      if (stablePressed) return true; // rising edge into pressed
    }
  }

  return false;
}

static void requestStop() {
  stopRequested = true;
  noTone(BUZZ_PIN);
}

// Toggle/start/switch logic
static void handleSongButton(SongId requested) {
  if (!isPlaying) {
    currentSong = requested;
    stopRequested = false;
    isPlaying = true;
    return;
  }

  if (currentSong == requested) {
    requestStop();
    isPlaying = false;
    currentSong = SONG_NONE;
    return;
  }

  // switch
  requestStop();
  currentSong = requested;
  stopRequested = false;
  isPlaying = true;
}

// Poll buttons frequently so stop/switch works during playback delays
static void pollButtonsDuringPlayback() {
  if (pressedEdge(BTN1_PIN, stable1, raw1, lastChange1)) handleSongButton(SONG_1);
  if (pressedEdge(BTN2_PIN, stable2, raw2, lastChange2)) handleSongButton(SONG_2);
  if (pressedEdge(BTN3_PIN, stable3, raw3, lastChange3)) handleSongButton(SONG_3);
}

// Delay that remains responsive to button presses
static void responsiveDelay(uint16_t ms) {
  uint32_t start = millis();
  while (!stopRequested && (millis() - start) < ms) {
    pollButtonsDuringPlayback();
    delay(1);
  }
}

static void playSongBlocking(
  const uint16_t *freqArr,
  const uint16_t *durArr,
  const uint16_t *gateArr,
  uint16_t nEvents
) {
  for (uint16_t i = 0; i < nEvents; i++) {
    if (stopRequested) break;

    uint16_t freq = pgm_read_word(&freqArr[i]);
    uint16_t dur  = pgm_read_word(&durArr[i]);
    uint16_t gate = pgm_read_word(&gateArr[i]);

    dur  = scaleMs(dur);
    gate = scaleMs(gate);
    if (gate > dur) gate = dur;

    if (freq == 0) {
      noTone(BUZZ_PIN);
      if (dur) responsiveDelay(dur);
      continue;
    }

    // Tone ON for gate
    if (gate > 0) {
      tone(BUZZ_PIN, freq);
      responsiveDelay(gate);
    }

    // Tone OFF for remainder
    noTone(BUZZ_PIN);
    uint16_t offMs = dur - gate;
    if (offMs > 0) responsiveDelay(offMs);

    if (EXTRA_GAP_MS && !stopRequested) responsiveDelay(EXTRA_GAP_MS);
  }

  noTone(BUZZ_PIN);
  stopRequested = false;
  isPlaying = false;
  currentSong = SONG_NONE;
}

void setup() {
  pinMode(BUZZ_PIN, OUTPUT);
  noTone(BUZZ_PIN);

  pinMode(BTN1_PIN, INPUT_PULLUP);
  pinMode(BTN2_PIN, INPUT_PULLUP);
  pinMode(BTN3_PIN, INPUT_PULLUP);
}

void loop() {
  // Idle polling (start song)
  if (!isPlaying) {
    if (pressedEdge(BTN1_PIN, stable1, raw1, lastChange1)) handleSongButton(SONG_1);
    if (pressedEdge(BTN2_PIN, stable2, raw2, lastChange2)) handleSongButton(SONG_2);
    if (pressedEdge(BTN3_PIN, stable3, raw3, lastChange3)) handleSongButton(SONG_3);
    return;
  }

  // Play selected song
  switch (currentSong) {
    case SONG_1:
      playSongBlocking(SONG1_FREQ_HZ, SONG1_DUR_MS, SONG1_GATE_MS, N_EVENTS_SONG1);
      break;
    case SONG_2:
      playSongBlocking(SONG2_FREQ_HZ, SONG2_DUR_MS, SONG2_GATE_MS, N_EVENTS_SONG2);
      break;
    case SONG_3:
      playSongBlocking(SONG3_FREQ_HZ, SONG3_DUR_MS, SONG3_GATE_MS, N_EVENTS_SONG3);
      break;
    default:
      isPlaying = false;
      currentSong = SONG_NONE;
      noTone(BUZZ_PIN);
      break;
  }
}
